name: Install and Debug SnowSQL

on:
  push:

jobs:
  install-snowsql:
    runs-on: ubuntu-latest

    env:
      SNOWSQL_VERSION: 1.4.4
      SNOWSQL_DIR: $HOME/snowsql

    steps:
      - name: Print Environment Details
        run: |
          set -ex
          echo "====üñ•Ô∏è OS & User Details===="
          uname -a
          whoami
          echo "HOME is: $HOME"
          echo "PWD is: $PWD"
          echo "PATH is: $PATH"
          echo "SNOWSQL_VERSION: $SNOWSQL_VERSION"
          echo "SNOWSQL_DIR: $SNOWSQL_DIR"

      - name: Prepare Directory and Download SnowSQL Installer
        run: |
          set -ex
          echo "====üìÇ Creating SNOWSQL_DIR: $SNOWSQL_DIR===="
          mkdir -p "$SNOWSQL_DIR"

          DOWNLOAD_URL="https://sfc-repo.snowflakecomputing.com/snowsql/bootstrap/1.4/linux_x86_64/snowsql-${SNOWSQL_VERSION}-linux_x86_64.bash"
          echo "====üåê Downloading SnowSQL installer from: $DOWNLOAD_URL===="
          curl -L -v -o "$SNOWSQL_DIR/snowsql-${SNOWSQL_VERSION}.bash" "$DOWNLOAD_URL"
          
          echo "====üìÑ Listing contents of SNOWSQL_DIR after download===="
          ls -alh "$SNOWSQL_DIR"

          echo "Making installer executable..."
          chmod +x "$SNOWSQL_DIR/snowsql-${SNOWSQL_VERSION}.bash"
          ls -l "$SNOWSQL_DIR/snowsql-${SNOWSQL_VERSION}.bash"

      - name: Install SnowSQL (with detailed debug)
        run: |
          set -ex
          echo "====üì¶ About to run SnowSQL installer===="
          echo "Listing SNOWSQL_DIR before install:"
          ls -alh "$SNOWSQL_DIR"
          echo "Installer file type:"
          file "$SNOWSQL_DIR/snowsql-${SNOWSQL_VERSION}.bash"

          echo "====üöÄ Running installer script===="
          bash "$SNOWSQL_DIR/snowsql-${SNOWSQL_VERSION}.bash" -y -d "$SNOWSQL_DIR" || {
            echo "‚ùå Installer script failed with exit code: $?"
            echo "====ü™µ Checking for install.log file ===="
            if [ -f "$SNOWSQL_DIR/install.log" ]; then
              echo "==== install.log BEGIN ===="
              cat "$SNOWSQL_DIR/install.log"
              echo "==== install.log END ===="
            else
              echo "No install.log found."
            fi
            exit 1
          }

          echo "====üìÑ Listing SNOWSQL_DIR contents after install===="
          ls -alh "$SNOWSQL_DIR"

          if [ -d "$SNOWSQL_DIR/bin" ]; then
            echo "====üìÑ Listing bin directory contents ===="
            ls -alh "$SNOWSQL_DIR/bin"
          else
            echo "‚ùó Warning: bin directory not found after installation!"
          fi

      - name: Add SnowSQL to PATH and Verify Installation
        run: |
          set -ex
          BIN_PATH="$SNOWSQL_DIR/bin"

          echo "====üîß Adding SnowSQL to PATH===="
          echo "$BIN_PATH" >> $GITHUB_PATH
          export PATH="$BIN_PATH:$PATH"
          echo "Current PATH: $PATH"

          echo "====üïµÔ∏è Verifying snowsql executable presence===="
          ls -alh "$BIN_PATH"
          which snowsql || { echo "‚ùå snowsql not found in PATH"; exit 1; }

          echo "====üß™ Running snowsql version command===="
          snowsql -v || { echo "‚ùå snowsql failed to execute"; exit 1; }

      - name: Print install.log if exists (always)
        if: always()
        run: |
          if [ -f "$SNOWSQL_DIR/install.log" ]; then
            echo "==== Printing install.log ===="
            cat "$SNOWSQL_DIR/install.log"
          else
            echo "No install.log found at end of job."
          fi
